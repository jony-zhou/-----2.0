# TECO SSP 加班時數計算器

## 功能說明

自動登入 TECO SSP 系統,抓取出勤異常清單資料,並計算每日加班時數。

### 新版改進

- ✅ **解決 SSL 憑證問題**: 自動處理公司內部網站的 SSL 憑證驗證問題
- ✅ **修正表格定位**: 正確解析 ASP.NET GridView 表格結構,支援動態 ID 匹配
- ✅ **增強 HTML 解析**: 支援多種 HTML 結構變化,更穩定的資料擷取
- ✅ **完整錯誤處理**: 詳細的日誌記錄和錯誤提示
- ✅ **改進日誌輸出**: 更清楚的處理流程與除錯資訊

## 加班時數計算公式

```
加班時數 = 下班時間 - 上班時間 - 70分鐘(午休) - 480分鐘(8小時正常上班) - 30分鐘(休息時間)
```

轉換為小時單位,例如: 1小時30分鐘 = 1.5 小時

## 安裝步驟

1. **安裝 Python 相依套件**

```bash
pip install -r requirements.txt
```

或個別安裝:

```bash
pip install requests beautifulsoup4 pandas openpyxl lxml
```

2. **執行程式**

```bash
python overtime_calculator.py
```

## 使用流程

1. 執行程式後,輸入您的 SSP 帳號和密碼
2. 程式會自動登入系統
3. 自動抓取「出勤異常清單(本月)」的所有資料(包含多頁)
4. 計算每日加班時數
5. 顯示統計報表
6. 可選擇匯出為 Excel 檔案

## 輸出報表範例

```
======================================================================
                        加班時數統計報表                        
======================================================================

      日期      上班時間    下班時間  加班時數
2025/11/18  08:55:54  20:00:28     1.6
2025/11/17  08:52:50  23:50:06     5.3
2025/11/14  08:55:23  19:18:06     0.9
2025/11/13  08:58:01  19:57:12     1.5
2025/11/11  09:00:25  19:23:01     0.9

----------------------------------------------------------------------
總加班時數: 45.2 小時
平均每日加班: 2.3 小時
最長加班: 5.3 小時
======================================================================
```

## 程式架構

### 主要類別: `OvertimeCalculator`

#### 方法說明

- `login(username, password)`: 登入系統
- `get_attendance_data()`: 取得所有出勤資料(自動處理分頁)
- `calculate_overtime(records)`: 計算加班時數
- `generate_report(df)`: 生成統計報表

### 資料處理流程

1. **登入階段**
   - 取得登入頁面的 ASP.NET ViewState 參數
   - 提交帳號密碼進行驗證
   - 維護 Session 狀態

2. **資料抓取階段**
   - 訪問出勤異常頁面
   - 解析 HTML 表格資料
   - 自動偵測並處理分頁
   - 使用 ASP.NET PostBack 機制翻頁

3. **計算階段**
   - 解析日期和時間字串
   - 計算總工作時間
   - 扣除固定時間(午休70分 + 上班480分 + 休息30分)
   - 轉換為小時單位

4. **報表輸出**
   - 使用 Pandas DataFrame 整理資料
   - 依日期排序
   - 計算統計數據
   - 可匯出為 Excel 格式

## 注意事項

1. **網路連線**: 需要能夠訪問 `https://ssp.teco.com.tw`
2. **帳號權限**: 需要有效的 SSP 系統帳號
3. **ASP.NET 網站**: 本程式處理 ASP.NET WebForms 的特殊機制
4. **時間格式**: 假設刷卡時間格式為 `HH:MM:SS`
5. **分頁處理**: 自動處理多頁資料

## 客製化調整

### 修改加班計算公式

如果您的公司規定不同,可以修改 `calculate_overtime` 方法中的計算邏輯:

```python
# 目前公式
overtime_minutes = total_minutes - 70 - 480 - 30

# 例如:不扣休息時間
overtime_minutes = total_minutes - 70 - 480
```

### 修改登入按鈕名稱

如果登入頁面的按鈕名稱不同,請修改 `login` 方法中的:

```python
login_data = {
    # ...
    'btnLogin': '登入'  # 修改為實際的按鈕名稱或 ID
}
```

### 增加錯誤處理

程式已包含基本的錯誤處理,如需更詳細的 log,可以加入 logging 模組。

## 疑難排解

### SSL 憑證驗證錯誤
如果遇到 `SSL: CERTIFICATE_VERIFY_FAILED` 錯誤:
- **原因**: 公司內部網站的 SSL 憑證可能不完整或缺少 Subject Key Identifier
- **解決**: 程式已預設關閉 SSL 驗證 (`verify_ssl=False`)
- **安全性**: 僅在內部網路使用時安全,請勿用於公開網路

### 登入失敗
- 檢查帳號密碼是否正確
- 確認網站是否可正常訪問
- 檢查登入頁面的表單欄位名稱

### 無法取得資料
- 確認登入後有權限訪問出勤異常頁面
- 檢查網頁結構是否有變更
- 查看 `overtime_calculator.log` 檔案了解詳細錯誤

### 時間計算錯誤
- 確認刷卡時間格式是否為 `HH:MM:SS`
- 檢查日期格式是否為 `YYYY/MM/DD`

## 授權與免責聲明

本程式僅供個人使用,請勿用於非法用途。使用本程式所產生的任何後果由使用者自行承擔。

## 更新記錄

- v2.1 (2025/11/20): 修正表格解析問題
  - 🔧 修正無法找到 ContentPlaceHolder1_gvWeb012 表格的問題
  - 🔧 移除無效的 #tabs-2 URL 錨點
  - ✨ 增強表格定位邏輯,支援多種 HTML 結構
  - ✨ 改進日誌輸出,提供更詳細的除錯資訊
  - ✨ 支援更靈活的 span ID 匹配 (日期/時間欄位)
  
- v2.0 (2025/11): 進階版
  - 配置檔案支援
  - 批次處理功能
  - 詳細日誌記錄
  
- v1.0 (2025/11): 初始版本
  - 自動登入功能
  - 多頁資料抓取
  - 加班時數計算
  - Excel 匯出功能